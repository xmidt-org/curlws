# SPDX-FileCopyrightText: 2021 Comcast Cable Communications Management, LLC
# SPDX-License-Identifier: MIT

name: CI

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - main
    tags-ignore:
      - 'v[0-9]**'
  schedule:
    - cron: '12 9 * * 3'


jobs:
  wsserver:
    name: Start WS Server
    runs-on: [ ubuntu-latest ]
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Start Autobahn Docker
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE/tools:/config" -v "$GITHUB_WORKSPACE/reports:/reports" -p 9001:9001 --name fuzzingserver crossbario/autobahn-testsuite &

      - name: Wait for coverage to be complete
        run: |
          tail -q -F -n 1 ../cjwt/build/meson-logs/coverage.xml | sed '/.*[a-z].*/ q'

  test:
    uses: xmidt-org/.github/.github/workflows/meson-unit-test.yml@main
    with:
      packages: jq libcurl4-openssl-dev
      extra-checks: autobahn_collect autobahn_validate
    secrets:
      sonar_login: ${{ secrets.SONAR_TOKEN }}
