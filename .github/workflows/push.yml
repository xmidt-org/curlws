# SPDX-FileCopyrightText: 2021 Comcast Cable Communications Management, LLC
# SPDX-License-Identifier: MIT

name: CI

on:
  pull_request:
  push:
  schedule:
    - cron: '12 9 * * 3'

jobs:
  ws-server:
    runs-on: [ ubuntu-latest ]
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
#      - name: Start Autobahn Docker
#        run: |
#          docker run --rm -v "$GITHUB_WORKSPACE/tools:/config" -v "$GITHUB_WORKSPACE/reports:/reports" -p 9001:9001 --name fuzzingserver crossbario/autobahn-testsuite &


    services:
      fuzzingserver:
        image: crossbario/autobahn-testsuite
        #options: -v "${GITHUB_WORKSPACE}/reports:/reports" -v "${GITHUB_WORKSPACE}/tools:/config"
        ports:
          - 9001:9001
          - 8080:8080
        volumes:
          - /reports:${GITHUB_WORKSPACE}/reports
          - /config:${GITHUB_WORKSPACE}/tools
        #options: -v "${GITHUB_WORKSPACE}/reports:/reports"
        #-v "${GITHUB_WORKSPACE}/tools:/config"

  test:
    needs: ws-server
    uses: xmidt-org/.github/.github/workflows/meson-unit-test.yml@main
    with:
      packages: jq libcurl4-openssl-dev
      extra-checks: autobahn_collect autobahn_validate
    secrets:
      sonar_login: ${{ secrets.SONAR_TOKEN }}
